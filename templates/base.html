<!doctype html>
<html lang="nl">
<head>
  <!-- Google tag (gtag.js) - Consent Required (GDPR/Belgian Law) -->
  {% if GA_ID %}
  <script async src="https://www.googletagmanager.com/gtag/js?id={{ GA_ID }}"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    // Default: deny all tracking until consent
    gtag('consent', 'default', {
      'analytics_storage': 'denied',
      'ad_storage': 'denied'
    });

    gtag('config', '{{ GA_ID }}', {
      'anonymize_ip': true // IP anonymization for GDPR
    });
  </script>
  {% endif %}

  <meta charset="utf-8">
  <title>{% block title %}TrendWatcher{% endblock %}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- SEO Meta Tags -->
  <meta name="description" content="{% block description %}Track trending crypto, stocks, e-commerce products, entertainment, and sports. Real-time data and insights.{% endblock %}">
  <meta name="keywords" content="{% block keywords %}trending, crypto, stocks, e-commerce, entertainment, sports, news, insights{% endblock %}">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="{{ request.url }}">
  <meta property="og:title" content="{% block og_title %}{{ self.title() }}{% endblock %}">
  <meta property="og:description" content="{% block og_description %}{{ self.description() }}{% endblock %}">
  <meta property="og:image" content="{% block og_image %}{{ url_for('static', filename='og-image.png', _external=True) }}{% endblock %}">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="{{ request.url }}">
  <meta name="twitter:title" content="{% block twitter_title %}{{ self.title() }}{% endblock %}">
  <meta name="twitter:description" content="{% block twitter_description %}{{ self.description() }}{% endblock %}">
  <meta name="twitter:image" content="{% block twitter_image %}{{ self.og_image() }}{% endblock %}">

  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="theme-{{ theme|default('newspaper') }}">
  {% include "partials/navbar.html" %}

  <main class="tw-container">
    <section class="tw-main">
      {% block content %}{% endblock %}
    </section>
    <aside class="tw-aside">
      {% block sidebar %}{% endblock %}
    </aside>
  </main>

  {% include "partials/footer.html" %}

  <!-- AJAX Refresh Functionality -->
  <script>
    /**
     * Refresh data voor een specifieke category
     * @param {string} category - crypto, stocks, entertainment, sports, ecommerce
     * @param {string} containerId - ID van container om bij te werken
     */
    function refreshData(category, containerId) {
      const button = event.target;
      const originalText = button.textContent;

      // Toon loading state
      button.textContent = 'Refreshing...';
      button.disabled = true;

      // Haal fresh data op via JSON API
      fetch(`/api/${category}/trending`)
        .then(response => response.json())
        .then(result => {
          if (result.success && result.data) {
            // Reload pagina om nieuwe data te tonen (simpelste oplossing)
            location.reload();
          } else {
            alert('Error refreshing data: ' + (result.error || 'Unknown error'));
            button.textContent = originalText;
            button.disabled = false;
          }
        })
        .catch(error => {
          console.error('Refresh error:', error);
          alert('Network error while refreshing');
          button.textContent = originalText;
          button.disabled = false;
        });
    }

    /**
     * Auto-refresh timer - refresh data elke N minuten
     * @param {number} minutes - Aantal minuten tussen refreshes
     */
    function startAutoRefresh(minutes) {
      const milliseconds = minutes * 60 * 1000;
      setInterval(() => {
        const currentPath = window.location.pathname;
        const category = currentPath.substring(1); // Remove leading /

        if (category && category !== '') {
          console.log(`Auto-refreshing ${category} data...`);
          location.reload();
        }
      }, milliseconds);
    }

    // Optional: Start auto-refresh elke 5 minuten
    // startAutoRefresh(5);
  </script>

  <!-- Cookie Consent Banner (must load before tracking) -->
  <script src="{{ url_for('static', filename='js/cookie-consent.js') }}"></script>

  <!-- Affiliate Click Tracking -->
  <script src="{{ url_for('static', filename='js/tracking.js') }}"></script>
</body>
</html>
